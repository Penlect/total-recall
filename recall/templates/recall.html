{% extends "base.html" %}

{% block css %}
<link href="{{ url_for('static', filename='css/recall.css') }}" rel="stylesheet">
{% block css_discipline_specific %}
<link href="{{ url_for('static', filename='css/recall_numbers.css') }}" rel="stylesheet">
{% endblock %}
{% endblock css %}

{% block body %}

    <div class="page-header">
        <h1>{{ current_user.username }}: Recall of id={{ memo.id }}</h1>
    </div>
    {% block subheader %}
    <h3>{{ memo.discipline.value }}, {{ memo.data|length }} st, {{ memo.recall_time }} min Recall</h3>
    {% endblock %}

    {% if view is not defined %}
    <button id="start_recall" class="btn btn-danger btn-lg" type="button">Start Recall</button>
    {% endif %}

    {% if view is not defined %}
    <form action="{{ url_for('arbeiter') }}" method="post">
    {% else %}
    <form>
    {% endif %}
        <fieldset>
        <div id="recallsheet" style="display:none;">
            <p>Seconds remaining: <span id="seconds_remaining">{{ seconds_remaining }}</span></p>

            <input name="memo_id" type="hidden" value="{{ memo.id }}">
            <input id="seconds_remaining_field" name="seconds_remaining" type="hidden">

            {% block table_logic %}
            {% endblock %}

            {% if view is not defined %}
            <button id="recall_submit_button" type="submit" class="btn btn-danger">Submit Recall</button>
            {% endif %}
        </div>
        </fieldset>
    </form>

	<div id="score_table" style="display:none;width=300px;">
        <h3>Score table</h3>
        <table>
            <tr>
                <td>Nr consecutive</td>
                <td id="consecutive">{% if view is defined %}{{ recall.correction.consecutive }}{% endif %}</td>
            </tr>
            <tr>
                <td>Nr correct</td>
                <td id="correct">{% if view is defined %}{{ recall.correction.correct }}{% endif %}</td>
            </tr>
            <tr>
                <td>Raw score</td>
                <td id="raw_score">{% if view is defined %}{{ recall.correction.raw_score }}{% endif %}</td>
            </tr>
            <tr>
                <td>Points</td>
                <td id="points">{% if view is defined %}{{ recall.correction.points }}{% endif %}</td>
            </tr>
        </table>

        {% if view is defined and recall.memo.user_id == current_user.id %}
        <p>
            <a href="{{ url_for('recorrect', recall_id = recall.id) }}"><span class="glyphicon glyphicon-refresh" aria-hidden="true"></span> Re-correct</a>
        </p>
        {% endif %}
    </div>

{% endblock body %}

{% block javascript%}
<script src="{{ url_for('static', filename='js/recall.js') }}"></script>

<script>

$(document).ready(function(){

    {% if view is not defined %}

    function recallSubmit(result, status, xhr){
        console.log(result);
        console.log(status);

        $("#recall_submit_button").remove();
        var arrayLength = result.cell_by_cell.length;
        for (var i = 0; i < arrayLength; i++){
            recallResultColor('recall_cell_' + i, result.cell_by_cell[i]);
        }
        $("#consecutive").text(result.consecutive);
        $("#correct").text(result.correct);
        $("#raw_score").text(result.raw_score);
        $("#points").text(result.points);
        $("#score_table").css("display", "block");
    }

    // The timer is started when the Start-Recall button is clicked
   $('#start_recall').on('click', function(event){
        $(this).remove();
        $('#recallsheet').css("display", "block");
        recallTimer = setTimeout(getRecallTimer($('#seconds_remaining'), $('#recall_submit_button')), SECOND);
   })

   var nrRows = $('.recall_table .recall_row').length;
   var nrCells = $('.recall_table .recall_cell').length;
   console.log("Rows = " + nrRows);
   console.log("Cells = " + nrCells);

   $('.recall_cell').keydown(function(event) {
       {% block keydown%}
           event.preventDefault();
           var grid = new RecallGrid(nrRows, nrCells/nrRows, $(this));
           keydownHandler(event, grid);
       {% endblock keydown%}
   });

   $('form').submit(function(event){
      console.log('Recall submit initiated');
	  event.preventDefault();

      // Copy seconds remaining to hidden input field
	  $('#seconds_remaining_field').val($('#seconds_remaining').text());

	  // Post all the recall input data to the server
      console.log('Posting data to server ...');
      $.post($(this).attr('action'), $(this).serialize(), recallSubmit, 'json');
      console.log('Done posting data to server ...');

      /* Disable the recall form because we don't want anyone
       to modify it after the time has run out */
      $('fieldset').prop('disabled', true);

      // Stop the clock from ticking
	  clearTimeout(recallTimer);
      return false;
   });
   {% else %}

   $('fieldset').prop('disabled', true);
   $('#recallsheet').css("display", "block");
   $("#score_table").css("display", "block");


   {% endif %}

});
</script>
{% endblock javascript %}

